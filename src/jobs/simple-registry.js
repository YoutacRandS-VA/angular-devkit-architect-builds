"use strict";
/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.SimpleJobRegistry = void 0;
const core_1 = require("@angular-devkit/core");
const rxjs_1 = require("rxjs");
const api_1 = require("./api");
const exception_1 = require("./exception");
/**
 * A simple job registry that keep a map of JobName => JobHandler internally.
 */
class SimpleJobRegistry {
    _jobNames = new Map();
    get(name) {
        return (0, rxjs_1.of)(this._jobNames.get(name) || null);
    }
    register(nameOrHandler, handlerOrOptions = {}, options = {}) {
        // Switch on the arguments.
        if (typeof nameOrHandler == 'string') {
            if (!(0, api_1.isJobHandler)(handlerOrOptions)) {
                // This is an error.
                throw new TypeError('Expected a JobHandler as second argument.');
            }
            this._register(nameOrHandler, handlerOrOptions, options);
        }
        else if ((0, api_1.isJobHandler)(nameOrHandler)) {
            if (typeof handlerOrOptions !== 'object') {
                // This is an error.
                throw new TypeError('Expected an object options as second argument.');
            }
            const name = options.name || nameOrHandler.jobDescription.name || handlerOrOptions.name;
            if (name === undefined) {
                throw new TypeError('Expected name to be a string.');
            }
            this._register(name, nameOrHandler, options);
        }
        else {
            throw new TypeError('Unrecognized arguments.');
        }
    }
    _register(name, handler, options) {
        if (this._jobNames.has(name)) {
            // We shouldn't allow conflicts.
            throw new exception_1.JobNameAlreadyRegisteredException(name);
        }
        // Merge all fields with the ones in the handler (to make sure we respect the handler).
        const argument = core_1.schema.mergeSchemas(handler.jobDescription.argument, options.argument);
        const input = core_1.schema.mergeSchemas(handler.jobDescription.input, options.input);
        const output = core_1.schema.mergeSchemas(handler.jobDescription.output, options.output);
        // Create the job description.
        const jobDescription = {
            name,
            argument,
            output,
            input,
        };
        const jobHandler = Object.assign(handler.bind(undefined), {
            jobDescription,
        });
        this._jobNames.set(name, jobHandler);
    }
    /**
     * Returns the job names of all jobs.
     */
    getJobNames() {
        return [...this._jobNames.keys()];
    }
}
exports.SimpleJobRegistry = SimpleJobRegistry;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltcGxlLXJlZ2lzdHJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYXJjaGl0ZWN0L3NyYy9qb2JzL3NpbXBsZS1yZWdpc3RyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7QUFFSCwrQ0FBeUQ7QUFDekQsK0JBQXNDO0FBQ3RDLCtCQUFvRjtBQUNwRiwyQ0FBZ0U7QUFRaEU7O0dBRUc7QUFDSCxNQUFhLGlCQUFpQjtJQU1wQixTQUFTLEdBQUcsSUFBSSxHQUFHLEVBR3hCLENBQUM7SUFFSixHQUFHLENBSUQsSUFBYTtRQUNiLE9BQU8sSUFBQSxTQUFFLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUEyQyxJQUFJLElBQUksQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUEyQkQsUUFBUSxDQUNOLGFBQStELEVBQy9ELG1CQUFnRixFQUFFLEVBQ2xGLFVBQThCLEVBQUU7UUFFaEMsMkJBQTJCO1FBQzNCLElBQUksT0FBTyxhQUFhLElBQUksUUFBUSxFQUFFO1lBQ3BDLElBQUksQ0FBQyxJQUFBLGtCQUFZLEVBQUMsZ0JBQWdCLENBQUMsRUFBRTtnQkFDbkMsb0JBQW9CO2dCQUNwQixNQUFNLElBQUksU0FBUyxDQUFDLDJDQUEyQyxDQUFDLENBQUM7YUFDbEU7WUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUMxRDthQUFNLElBQUksSUFBQSxrQkFBWSxFQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQ3RDLElBQUksT0FBTyxnQkFBZ0IsS0FBSyxRQUFRLEVBQUU7Z0JBQ3hDLG9CQUFvQjtnQkFDcEIsTUFBTSxJQUFJLFNBQVMsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO2FBQ3ZFO1lBRUQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksSUFBSSxhQUFhLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7WUFDeEYsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO2dCQUN0QixNQUFNLElBQUksU0FBUyxDQUFDLCtCQUErQixDQUFDLENBQUM7YUFDdEQ7WUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDOUM7YUFBTTtZQUNMLE1BQU0sSUFBSSxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQztTQUNoRDtJQUNILENBQUM7SUFFUyxTQUFTLENBS2pCLElBQWEsRUFDYixPQUErQyxFQUMvQyxPQUEyQjtRQUUzQixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzVCLGdDQUFnQztZQUNoQyxNQUFNLElBQUksNkNBQWlDLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkQ7UUFFRCx1RkFBdUY7UUFDdkYsTUFBTSxRQUFRLEdBQUcsYUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEYsTUFBTSxLQUFLLEdBQUcsYUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0UsTUFBTSxNQUFNLEdBQUcsYUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFbEYsOEJBQThCO1FBQzlCLE1BQU0sY0FBYyxHQUFtQjtZQUNyQyxJQUFJO1lBQ0osUUFBUTtZQUNSLE1BQU07WUFDTixLQUFLO1NBQ04sQ0FBQztRQUVGLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUN4RCxjQUFjO1NBQ2YsQ0FBMEYsQ0FBQztRQUM1RixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsV0FBVztRQUNULE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNwQyxDQUFDO0NBQ0Y7QUFqSEQsOENBaUhDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7IEpzb25WYWx1ZSwgc2NoZW1hIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEpvYkRlc2NyaXB0aW9uLCBKb2JIYW5kbGVyLCBKb2JOYW1lLCBSZWdpc3RyeSwgaXNKb2JIYW5kbGVyIH0gZnJvbSAnLi9hcGknO1xuaW1wb3J0IHsgSm9iTmFtZUFscmVhZHlSZWdpc3RlcmVkRXhjZXB0aW9uIH0gZnJvbSAnLi9leGNlcHRpb24nO1xuXG4vKipcbiAqIFNpbXBsZUpvYlJlZ2lzdHJ5IGpvYiByZWdpc3RyYXRpb24gb3B0aW9ucy5cbiAqL1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1pbnRlcmZhY2VcbmV4cG9ydCBpbnRlcmZhY2UgUmVnaXN0ZXJKb2JPcHRpb25zIGV4dGVuZHMgUGFydGlhbDxKb2JEZXNjcmlwdGlvbj4ge31cblxuLyoqXG4gKiBBIHNpbXBsZSBqb2IgcmVnaXN0cnkgdGhhdCBrZWVwIGEgbWFwIG9mIEpvYk5hbWUgPT4gSm9iSGFuZGxlciBpbnRlcm5hbGx5LlxuICovXG5leHBvcnQgY2xhc3MgU2ltcGxlSm9iUmVnaXN0cnk8XG4gIE1pbmltdW1Bcmd1bWVudFZhbHVlVCBleHRlbmRzIEpzb25WYWx1ZSA9IEpzb25WYWx1ZSxcbiAgTWluaW11bUlucHV0VmFsdWVUIGV4dGVuZHMgSnNvblZhbHVlID0gSnNvblZhbHVlLFxuICBNaW5pbXVtT3V0cHV0VmFsdWVUIGV4dGVuZHMgSnNvblZhbHVlID0gSnNvblZhbHVlLFxuPiBpbXBsZW1lbnRzIFJlZ2lzdHJ5PE1pbmltdW1Bcmd1bWVudFZhbHVlVCwgTWluaW11bUlucHV0VmFsdWVULCBNaW5pbXVtT3V0cHV0VmFsdWVUPlxue1xuICBwcml2YXRlIF9qb2JOYW1lcyA9IG5ldyBNYXA8XG4gICAgSm9iTmFtZSxcbiAgICBKb2JIYW5kbGVyPE1pbmltdW1Bcmd1bWVudFZhbHVlVCwgTWluaW11bUlucHV0VmFsdWVULCBNaW5pbXVtT3V0cHV0VmFsdWVUPlxuICA+KCk7XG5cbiAgZ2V0PFxuICAgIEEgZXh0ZW5kcyBNaW5pbXVtQXJndW1lbnRWYWx1ZVQgPSBNaW5pbXVtQXJndW1lbnRWYWx1ZVQsXG4gICAgSSBleHRlbmRzIE1pbmltdW1JbnB1dFZhbHVlVCA9IE1pbmltdW1JbnB1dFZhbHVlVCxcbiAgICBPIGV4dGVuZHMgTWluaW11bU91dHB1dFZhbHVlVCA9IE1pbmltdW1PdXRwdXRWYWx1ZVQsXG4gID4obmFtZTogSm9iTmFtZSk6IE9ic2VydmFibGU8Sm9iSGFuZGxlcjxBLCBJLCBPPiB8IG51bGw+IHtcbiAgICByZXR1cm4gb2YoKHRoaXMuX2pvYk5hbWVzLmdldChuYW1lKSBhcyB1bmtub3duIGFzIEpvYkhhbmRsZXI8QSwgSSwgTz4gfCBudWxsKSB8fCBudWxsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIGpvYiBoYW5kbGVyLiBUaGUgbmFtZSBtdXN0IGJlIHVuaXF1ZS5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIGpvYi5cbiAgICogQHBhcmFtIGhhbmRsZXIgVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgZm9yIHRoZSBqb2IuXG4gICAqIEBwYXJhbSBvcHRpb25zIEFuIG9wdGlvbmFsIGxpc3Qgb2Ygb3B0aW9ucyB0byBvdmVycmlkZSB0aGUgaGFuZGxlci4ge0BzZWUgUmVnaXN0ZXJKb2JPcHRpb25zfVxuICAgKi9cbiAgcmVnaXN0ZXI8XG4gICAgQSBleHRlbmRzIE1pbmltdW1Bcmd1bWVudFZhbHVlVCxcbiAgICBJIGV4dGVuZHMgTWluaW11bUlucHV0VmFsdWVULFxuICAgIE8gZXh0ZW5kcyBNaW5pbXVtT3V0cHV0VmFsdWVULFxuICA+KG5hbWU6IEpvYk5hbWUsIGhhbmRsZXI6IEpvYkhhbmRsZXI8QSwgSSwgTz4sIG9wdGlvbnM/OiBSZWdpc3RlckpvYk9wdGlvbnMpOiB2b2lkO1xuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIGpvYiBoYW5kbGVyLiBUaGUgbmFtZSBtdXN0IGJlIHVuaXF1ZS5cbiAgICpcbiAgICogQHBhcmFtIGhhbmRsZXIgVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgZm9yIHRoZSBqb2IuXG4gICAqIEBwYXJhbSBvcHRpb25zIEFuIG9wdGlvbmFsIGxpc3Qgb2Ygb3B0aW9ucyB0byBvdmVycmlkZSB0aGUgaGFuZGxlci4ge0BzZWUgUmVnaXN0ZXJKb2JPcHRpb25zfVxuICAgKi9cbiAgcmVnaXN0ZXI8QXJndW1lbnRUIGV4dGVuZHMgSnNvblZhbHVlLCBJbnB1dFQgZXh0ZW5kcyBKc29uVmFsdWUsIE91dHB1dFQgZXh0ZW5kcyBKc29uVmFsdWU+KFxuICAgIGhhbmRsZXI6IEpvYkhhbmRsZXI8QXJndW1lbnRULCBJbnB1dFQsIE91dHB1dFQ+LFxuICAgIC8vIFRoaXMgdmVyc2lvbiBNVVNUIGNvbnRhaW4gYSBuYW1lLlxuICAgIG9wdGlvbnM/OiBSZWdpc3RlckpvYk9wdGlvbnMgJiB7IG5hbWU6IHN0cmluZyB9LFxuICApOiB2b2lkO1xuXG4gIHJlZ2lzdGVyPEFyZ3VtZW50VCBleHRlbmRzIEpzb25WYWx1ZSwgSW5wdXRUIGV4dGVuZHMgSnNvblZhbHVlLCBPdXRwdXRUIGV4dGVuZHMgSnNvblZhbHVlPihcbiAgICBuYW1lT3JIYW5kbGVyOiBKb2JOYW1lIHwgSm9iSGFuZGxlcjxBcmd1bWVudFQsIElucHV0VCwgT3V0cHV0VD4sXG4gICAgaGFuZGxlck9yT3B0aW9uczogSm9iSGFuZGxlcjxBcmd1bWVudFQsIElucHV0VCwgT3V0cHV0VD4gfCBSZWdpc3RlckpvYk9wdGlvbnMgPSB7fSxcbiAgICBvcHRpb25zOiBSZWdpc3RlckpvYk9wdGlvbnMgPSB7fSxcbiAgKTogdm9pZCB7XG4gICAgLy8gU3dpdGNoIG9uIHRoZSBhcmd1bWVudHMuXG4gICAgaWYgKHR5cGVvZiBuYW1lT3JIYW5kbGVyID09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAoIWlzSm9iSGFuZGxlcihoYW5kbGVyT3JPcHRpb25zKSkge1xuICAgICAgICAvLyBUaGlzIGlzIGFuIGVycm9yLlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdFeHBlY3RlZCBhIEpvYkhhbmRsZXIgYXMgc2Vjb25kIGFyZ3VtZW50LicpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl9yZWdpc3RlcihuYW1lT3JIYW5kbGVyLCBoYW5kbGVyT3JPcHRpb25zLCBvcHRpb25zKTtcbiAgICB9IGVsc2UgaWYgKGlzSm9iSGFuZGxlcihuYW1lT3JIYW5kbGVyKSkge1xuICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyT3JPcHRpb25zICE9PSAnb2JqZWN0Jykge1xuICAgICAgICAvLyBUaGlzIGlzIGFuIGVycm9yLlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdFeHBlY3RlZCBhbiBvYmplY3Qgb3B0aW9ucyBhcyBzZWNvbmQgYXJndW1lbnQuJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5hbWUgPSBvcHRpb25zLm5hbWUgfHwgbmFtZU9ySGFuZGxlci5qb2JEZXNjcmlwdGlvbi5uYW1lIHx8IGhhbmRsZXJPck9wdGlvbnMubmFtZTtcbiAgICAgIGlmIChuYW1lID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgbmFtZSB0byBiZSBhIHN0cmluZy4nKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fcmVnaXN0ZXIobmFtZSwgbmFtZU9ySGFuZGxlciwgb3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1VucmVjb2duaXplZCBhcmd1bWVudHMuJyk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIF9yZWdpc3RlcjxcbiAgICBBcmd1bWVudFQgZXh0ZW5kcyBKc29uVmFsdWUsXG4gICAgSW5wdXRUIGV4dGVuZHMgSnNvblZhbHVlLFxuICAgIE91dHB1dFQgZXh0ZW5kcyBKc29uVmFsdWUsXG4gID4oXG4gICAgbmFtZTogSm9iTmFtZSxcbiAgICBoYW5kbGVyOiBKb2JIYW5kbGVyPEFyZ3VtZW50VCwgSW5wdXRULCBPdXRwdXRUPixcbiAgICBvcHRpb25zOiBSZWdpc3RlckpvYk9wdGlvbnMsXG4gICk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9qb2JOYW1lcy5oYXMobmFtZSkpIHtcbiAgICAgIC8vIFdlIHNob3VsZG4ndCBhbGxvdyBjb25mbGljdHMuXG4gICAgICB0aHJvdyBuZXcgSm9iTmFtZUFscmVhZHlSZWdpc3RlcmVkRXhjZXB0aW9uKG5hbWUpO1xuICAgIH1cblxuICAgIC8vIE1lcmdlIGFsbCBmaWVsZHMgd2l0aCB0aGUgb25lcyBpbiB0aGUgaGFuZGxlciAodG8gbWFrZSBzdXJlIHdlIHJlc3BlY3QgdGhlIGhhbmRsZXIpLlxuICAgIGNvbnN0IGFyZ3VtZW50ID0gc2NoZW1hLm1lcmdlU2NoZW1hcyhoYW5kbGVyLmpvYkRlc2NyaXB0aW9uLmFyZ3VtZW50LCBvcHRpb25zLmFyZ3VtZW50KTtcbiAgICBjb25zdCBpbnB1dCA9IHNjaGVtYS5tZXJnZVNjaGVtYXMoaGFuZGxlci5qb2JEZXNjcmlwdGlvbi5pbnB1dCwgb3B0aW9ucy5pbnB1dCk7XG4gICAgY29uc3Qgb3V0cHV0ID0gc2NoZW1hLm1lcmdlU2NoZW1hcyhoYW5kbGVyLmpvYkRlc2NyaXB0aW9uLm91dHB1dCwgb3B0aW9ucy5vdXRwdXQpO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBqb2IgZGVzY3JpcHRpb24uXG4gICAgY29uc3Qgam9iRGVzY3JpcHRpb246IEpvYkRlc2NyaXB0aW9uID0ge1xuICAgICAgbmFtZSxcbiAgICAgIGFyZ3VtZW50LFxuICAgICAgb3V0cHV0LFxuICAgICAgaW5wdXQsXG4gICAgfTtcblxuICAgIGNvbnN0IGpvYkhhbmRsZXIgPSBPYmplY3QuYXNzaWduKGhhbmRsZXIuYmluZCh1bmRlZmluZWQpLCB7XG4gICAgICBqb2JEZXNjcmlwdGlvbixcbiAgICB9KSBhcyB1bmtub3duIGFzIEpvYkhhbmRsZXI8TWluaW11bUFyZ3VtZW50VmFsdWVULCBNaW5pbXVtSW5wdXRWYWx1ZVQsIE1pbmltdW1PdXRwdXRWYWx1ZVQ+O1xuICAgIHRoaXMuX2pvYk5hbWVzLnNldChuYW1lLCBqb2JIYW5kbGVyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBqb2IgbmFtZXMgb2YgYWxsIGpvYnMuXG4gICAqL1xuICBnZXRKb2JOYW1lcygpOiBKb2JOYW1lW10ge1xuICAgIHJldHVybiBbLi4udGhpcy5fam9iTmFtZXMua2V5cygpXTtcbiAgfVxufVxuIl19